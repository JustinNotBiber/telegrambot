import telebot
import random
import datetime
import json
import os
import time

BOT_TOKEN = "8397096460:AAFaipDEsVl-PLNBZKPsMqfNQZ5OwYs9OxM"
bot = telebot.TeleBot(BOT_TOKEN)

DATA_FILE = "data.json"

# === –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ===
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        data = json.load(f)
        players_iq = data.get("players_iq", {})
        last_used = {int(k): datetime.datetime.fromisoformat(v) for k, v in data.get("last_used", {}).items()}
else:
    players_iq = {}
    last_used = {}

EVENTS = [
    ("–í–∞–º –ø–æ–ø–∞–ª—Å—è —ç–¥–∏—Ç —Å —Å–∏–≥–º–æ–π! +5 –∫ IQ", 5, 60),
    ("–í—ã –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏ –î—ç–≤–∏–¥–∞ –ì–æ–≥–≥–∏–Ω—Å–∞! +10 –∫ IQ", 10, 30),
    ("–í–∞–º –ø–æ–ø–∞–ª—Å—è –≤–∏–¥–µ–æ –ø—Ä–æ Dark fantasy! +10 –∫ IQ", 10, 25),
    ("–í—ã —É—Å—Ç—Ä–æ–∏–ª–∏ –±–µ—Å–µ–¥—É —Å —Å–∞–º–∏–º —Å–æ–±–æ–π! +12 –∫ IQ", 12, 19),
    ("–í—ã –≤–ø–µ—Ä–≤—ã–µ –≤ –∂–∏–∑–Ω–∏ –æ—Ç–∫—Ä—ã–ª–∏ –∫–Ω–∏–≥—É! +6 –∫ IQ", 6, 30),
    ("–í–∞—Å —É–∫—É—Å–∏–ª –ø–∞—É–∫ –∏ –≤—ã –∑–∞—Ö–æ—Ç–µ–ª–∏ –ø—Ä—ã–≥–∞—Ç—å –ø–æ –∫—Ä—ã—à–∞–º,–Ω–æ —Å–ª–æ–º–∞–ª–∏ –Ω–æ–≥—É... -10 –∫ IQ", -10, 8),
    ("–£ –≤–∞—Å –ø–æ—è–≤–∏–ª–∏—Å—å –º—ã—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–µ –±—É–¥—É—â–µ–µ! +9 –∫ IQ", 9, 15),
    ("–í—ã –ø–æ—Å–ª—É—à–∞–ª–∏ –ø–µ—Å–Ω—é –¶–æ—è! +11 –∫ IQ", 11, 14),
    ("–í—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ 8 —á–∞—Å–æ–≤ –ø–æ–¥–∫–∞—Å—Ç–∞ –æ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏! +15 –∫ IQ", 15, 5),
    ("–í—ã –ø–æ—Å–ª—É—à–∞–ª–∏ 1 –ø–µ—Å–Ω—é –î–∂–∞—Å—Ç–∞! +1 –∫ IQ", 1, 1),
    ("–í–∞–º –ø–æ–ø–∞–ª—Å—è —Ñ—É—Ä—Ä–∏ –≤–∏–¥–µ–æ. -15 –∫ IQ", -13, 8),
    ("–í—ã —Å—Ç—É–∫–Ω—É–ª–∏—Å—å –≥–æ–ª–æ–≤–æ–π –æ–± —Å—Ç–µ–Ω–∫—É. -10 –∫ IQ", -10, 10),
    ("–í—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –∞–Ω–∏–º–µ. -5 –∫ IQ", -5, 15),
    ("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–¥–æ,–±—Ä–∞—Ç,–ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç –º–µ–Ω—è. +10 –∫ IQ", 10, 15),
]

# === –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ ===
def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump({
            "players_iq": players_iq,
            "last_used": {k: v.isoformat() for k, v in last_used.items()}
        }, f, ensure_ascii=False, indent=2)

def weighted_random_event():
    total_weight = sum(e[2] for e in EVENTS)
    r = random.uniform(0, total_weight)
    cumulative = 0
    for event, change, weight in EVENTS:
        cumulative += weight
        if r <= cumulative:
            return event, change

def can_use(user_id):
    now = datetime.datetime.now()
    last = last_used.get(user_id)
    if not last:
        return True
    diff = now - last
    return diff.total_seconds() >= 12 * 3600  # 12 —á–∞—Å–æ–≤

@bot.message_handler(commands=['rofle'])
def rofle(message):
    user_id = message.from_user.id
    username = message.from_user.first_name

    if not can_use(user_id):
        bot.reply_to(message, "‚è∞ –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Ä–æ—Ñ–ª! –ü–æ–¥–æ–∂–¥–∏—Ç–µ 12 —á–∞—Å–æ–≤ üòâ")
        return

    event, change = weighted_random_event()
    iq = players_iq.get(str(user_id), 100) + change
    players_iq[str(user_id)] = iq
    last_used[user_id] = datetime.datetime.now()

    save_data()  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è

    text = f"{event}\n\nüß© {username}, —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å {iq} IQ!"
    bot.reply_to(message, text)

@bot.message_handler(commands=['top'])
def top_players(message):
    if not players_iq:
        bot.reply_to(message, "üò¥ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª.")
        return

    sorted_players = sorted(players_iq.items(), key=lambda x: x[1], reverse=True)
    text = "üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ IQ:\n\n"
    for i, (uid, iq) in enumerate(sorted_players[:10], start=1):
        text += f"{i}. {iq} IQ\n"

    bot.reply_to(message, text)

@bot.message_handler(commands=['start'])
def start(message):
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø IQ-—Ä–æ—Ñ–ª-–±–æ—Ç ü§ñ\n\n"
        "üß© –ò—Å–ø–æ–ª—å–∑—É–π /rofle ‚Äî —á—Ç–æ–±—ã –∏—Å–ø—ã—Ç–∞—Ç—å —Å—É–¥—å–±—É (—Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤)\n"
        "üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî /top"
    )
    bot.reply_to(message, text)

print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.polling(none_stop=True)
